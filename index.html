<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinite Board v5.0 Core</title>
    <style>
        :root { --bg: #f4f4f9; --panel: #ffffff; --accent: #4285F4; --text: #333; }
        [data-theme="dark"] { --bg: #1e1e1e; --panel: #2d2d2d; --accent: #64b5f6; --text: #eee; }
        
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* –°–õ–û–ò: */
        /* 1. DOM Layer (–í–∏–¥–µ–æ/–ö–∞—Ä—Ç–∏–Ω–∫–∏) - z-index: 10 */
        #dom-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; overflow: visible; }
        
        /* 2. Canvas (–†–∏—Å–æ–≤–∞–Ω–∏–µ –∏ –ñ–µ—Å—Ç—ã) - z-index: 100 */
        #canvas { position: absolute; inset: 0; z-index: 100; touch-action: none; background: transparent; }
        
        /* 3. UI - z-index: 1000 */
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; pointer-events: none; z-index: 1000; display: flex; flex-direction: column; align-items: center; }
        
        /* –°—Ç–∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–≤ */
        .obj-wrapper { position: absolute; pointer-events: none; transform-origin: 0 0; will-change: transform; }
        .yt-frame { width: 100%; height: 100%; border: none; pointer-events: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–ª–∏–∫–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç */ box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 4px; background: #000; }
        
        /* –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∫–æ–≥–¥–∞ –≤–∏–¥–µ–æ "–≤—Å–ø–ª—ã–ª–æ") */
        .obj-wrapper.interactive { z-index: 500 !important; pointer-events: auto !important; }
        .obj-wrapper.interactive .yt-frame { pointer-events: auto !important; box-shadow: 0 0 0 4px var(--accent); }

        /* UI –≠–ª–µ–º–µ–Ω—Ç—ã */
        .panel { pointer-events: auto; background: var(--panel); padding: 8px 16px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; gap: 8px; align-items: center; margin-top: 10px; transition: 0.2s; }
        button { background: transparent; border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 18px; color: var(--text); transition: background 0.1s; }
        button:hover { background: rgba(0,0,0,0.05); }
        button.active { background: var(--accent); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        #sidebar { position: fixed; top: 70px; left: 10px; width: 240px; background: var(--panel); border-radius: 12px; padding: 15px; pointer-events: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: translateX(-280px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1001; display: flex; flex-direction: column; max-height: 80vh; }
        #sidebar.open { transform: translateX(0); }
        
        .board-item { padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 4px; color: var(--text); border: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; }
        .board-item:hover { background: rgba(0,0,0,0.03); }
        .board-item.active { background: rgba(66, 133, 244, 0.1); border-color: var(--accent); color: var(--accent); font-weight: 600; }

        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-btn { background: #4285F4; color: white; padding: 12px 24px; font-size: 16px; font-weight: 500; }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
        #hint { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 2000; }
    </style>
</head>
<body class="mode-move">

<div id="login-screen">
    <h1 style="color:var(--text); margin-bottom: 20px;">Infinite Board v5.0</h1>
    <button class="login-btn" onclick="login()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
</div>

<div id="ui-layer" style="display:none;">
    <div class="panel">
        <button onclick="toggleSidebar()" title="–ú–µ–Ω—é –¥–æ—Å–æ–∫">‚ò∞</button>
        <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
        <button id="mode-move" class="active" onclick="setMode('move')" title="–†—É–∫–∞ (–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ)">üñêÔ∏è</button>
        <button id="mode-select" onclick="setMode('select')" title="–ö—É—Ä—Å–æ—Ä (–í—ã–±–æ—Ä/–†–µ—Å–∞–π–∑)">‚ÜñÔ∏è</button>
        <button id="mode-draw" onclick="setMode('draw')" title="–ö–∞—Ä–∞–Ω–¥–∞—à">‚úèÔ∏è</button>
        <button id="mode-eraser" onclick="setMode('eraser')" title="–õ–∞—Å—Ç–∏–∫">üßΩ</button>
        <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
        <button onclick="resetCamera()" title="–°–±—Ä–æ—Å –∫–∞–º–µ—Ä—ã">üéØ</button>
        <input type="file" id="file-input" hidden onchange="handleFile(event)">
        <button onclick="document.getElementById('file-input').click()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª">üñºÔ∏è</button>
        <button onclick="addYouTube()" style="color: #ff0000;" title="–î–æ–±–∞–≤–∏—Ç—å YouTube">‚ñ∂</button>
        <button onclick="deleteSelected()" title="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ">üóëÔ∏è</button>
    </div>
    <div class="panel" style="margin-top: 0; transform: scale(0.9);">
        <button onclick="undo()">‚Ü©Ô∏è</button>
        <button onclick="redo()">‚Ü™Ô∏è</button>
        <button onclick="toggleTheme()">üåì</button>
    </div>
</div>

<div id="sidebar">
    <h3 style="margin-top:0; color: var(--text);">–ú–æ–∏ –î–æ—Å–∫–∏</h3>
    <div id="boards-list" style="overflow-y: auto; flex: 1;"></div>
    <button onclick="createNewBoard()" style="width:100%; background:var(--accent); color:white; margin-top:15px; padding: 10px;">+ –ù–æ–≤–∞—è –¥–æ—Å–∫–∞</button>
    <button onclick="logout()" style="width:100%; margin-top:10px; opacity: 0.6; font-size: 14px;">–í—ã—Ö–æ–¥</button>
</div>

<div id="hint">–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –≤–∏–¥–µ–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>

<div id="canvas-container">
    <div id="dom-layer"></div>
    <canvas id="canvas"></canvas>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAYZY3gBo7uT-MSmgXnsZn3Y_q2zzU4OAM",
        authDomain: "infiniteboard-3197d.firebaseapp.com",
        projectId: "infiniteboard-3197d",
        storageBucket: "infiniteboard-3197d.firebasestorage.app",
        appId: "1:786069509066:web:ab900d2d7c952195067533"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app), db = getFirestore(app);

    // --- STATE ---
    let state = { 
        mode: 'move', // move (pan), select (drag/resize), draw, eraser
        theme: 'light', 
        camera: { x: window.innerWidth/2, y: window.innerHeight/2, zoom: 1 }, 
        objects: [], 
        lines: [], 
        selectedObj: null,
        interactiveId: null // ID –æ–±—ä–µ–∫—Ç–∞, —Å –∫–æ—Ç–æ—Ä—ã–º —Å–µ–π—á–∞—Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ–º (YouTube play)
    };
    let currentUser = null, currentBoardId = null, unsubscribeBoard = null;
    
    // --- CANVAS SETUP ---
    const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
    const domLayer = document.getElementById('dom-layer');

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        render();
    }
    window.addEventListener('resize', resize);
    resize();

    // --- CORE LOGIC: SYNC DOM ---
    function syncDOMObjects(data) {
        // 1. Identify active IDs
        const validIds = new Set(data.map(o => o.id));
        
        // 2. Remove dead DOM elements
        state.objects.forEach(obj => {
            if (obj.dom && !validIds.has(obj.id)) {
                obj.dom.remove();
            }
        });

        // 3. Update or Create
        state.objects = data.map(serverObj => {
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø–æ ID
            let localObj = state.objects.find(o => o.id === serverObj.id);
            
            if (localObj) {
                // –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç —É–∂–µ –µ—Å—Ç—å, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ, –Ω–æ –ù–ï —Ç—Ä–æ–≥–∞–µ–º DOM innerHTML (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
                Object.assign(localObj, serverObj);
                return localObj;
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                if (serverObj.type === 'youtube') {
                    const div = document.createElement('div');
                    div.className = 'obj-wrapper';
                    div.id = `obj-${serverObj.id}`;
                    // –í–∞–∂–Ω–æ: IFrame –ø–æ–ª—É—á–∞–µ—Ç pointer-events: none —á–µ—Ä–µ–∑ CSS –∫–ª–∞—Å—Å–∞ .yt-frame, –ø–æ–∫–∞ –Ω–µ —Å—Ç–∞–Ω–µ—Ç interactive
                    div.innerHTML = `<iframe class="yt-frame" src="https://www.youtube.com/embed/${serverObj.ytId}?enablejsapi=1&rel=0" allowfullscreen></iframe>`;
                    domLayer.appendChild(div);
                    serverObj.dom = div;
                } else if (serverObj.type === 'image') {
                    serverObj.el = new Image();
                    serverObj.el.src = serverObj.url;
                }
                return serverObj;
            }
        });
        render();
    }

    // --- INPUT HANDLING ---
    // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤–∏–¥–µ–æ
    canvas.addEventListener('dblclick', e => {
        const m = getMouse(e);
        const w = toWorld(m);
        const hit = findHit(w);
        
        if (hit && hit.type === 'youtube') {
            state.interactiveId = hit.id;
            showHint("–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞. –ö–ª–∏–∫–Ω–∏—Ç–µ –º–∏–º–æ, —á—Ç–æ–±—ã –≤—ã–π—Ç–∏.");
            render();
        }
    });

    // –û–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –º–∏–º–æ
    window.addEventListener('pointerdown', e => {
        if (state.interactiveId && e.target.tagName !== 'IFRAME') {
            state.interactiveId = null; // –í—ã—Ö–æ–¥ –∏–∑ —Ä–µ–∂–∏–º–∞ –≤–∏–¥–µ–æ
            render();
        }
    });

    canvas.addEventListener('pointerdown', e => {
        const m = getMouse(e);
        const w = toWorld(m);
        state.lastMouse = m;
        const hit = findHit(w);

        // –õ–æ–≥–∏–∫–∞ –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º
        if (state.mode === 'move') {
            state.isDragging = true; // –¢–æ–ª—å–∫–æ –¥–≤–∏–≥–∞–µ–º –∫–∞–º–µ—Ä—É
        } 
        else if (state.mode === 'select') {
            if (hit) {
                state.selectedObj = hit;
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ—Å–∞–π–∑ (–ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª)
                const s = 30 / state.camera.zoom;
                if (w.x > hit.x + hit.w - s && w.y > hit.y + hit.h - s) {
                    state.isResizing = true;
                } else {
                    state.isMovingObj = true;
                }
            } else {
                state.selectedObj = null; // –°–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è
            }
        } 
        else if (state.mode === 'draw') {
            state.isDrawing = true;
            state.lines.push({ points: [w], color: state.theme === 'light' ? '#000' : '#fff' });
        }
        else if (state.mode === 'eraser') {
            state.isDrawing = true; // Eraser logic inside move
        }

        render();
    });

    canvas.addEventListener('pointermove', e => {
        if (!state.lastMouse) return;
        const m = getMouse(e);
        const dx = (m.x - state.lastMouse.x) / state.camera.zoom;
        const dy = (m.y - state.lastMouse.y) / state.camera.zoom;
        const w = toWorld(m);

        if (state.mode === 'move' && state.isDragging) {
            state.camera.x += m.x - state.lastMouse.x;
            state.camera.y += m.y - state.lastMouse.y;
        }
        else if (state.mode === 'select') {
            if (state.isResizing && state.selectedObj) {
                state.selectedObj.w += dx;
                state.selectedObj.h = state.selectedObj.w / (state.selectedObj.ratio || 1.77);
            } else if (state.isMovingObj && state.selectedObj) {
                state.selectedObj.x += dx;
                state.selectedObj.y += dy;
            }
        }
        else if (state.isDrawing) {
             if (state.mode === 'draw') {
                 state.lines[state.lines.length - 1].points.push(w);
             } else if (state.mode === 'eraser') {
                 state.lines = state.lines.filter(l => !l.points.some(p => Math.hypot(p.x - w.x, p.y - w.y) < 20 / state.camera.zoom));
             }
        }

        state.lastMouse = m;
        render();
    });

    window.addEventListener('pointerup', () => {
        if (state.isMovingObj || state.isResizing || state.isDrawing) save();
        state.isDragging = state.isMovingObj = state.isResizing = state.isDrawing = false;
        state.lastMouse = null;
    });

    canvas.addEventListener('wheel', e => {
        e.preventDefault();
        const d = e.deltaY > 0 ? 0.9 : 1.1;
        const m = getMouse(e);
        const wX = (m.x - state.camera.x) / state.camera.zoom;
        const wY = (m.y - state.camera.y) / state.camera.zoom;
        state.camera.zoom = Math.min(Math.max(state.camera.zoom * d, 0.05), 5);
        state.camera.x = m.x - wX * state.camera.zoom;
        state.camera.y = m.y - wY * state.camera.zoom;
        render();
    }, { passive: false });

    // --- RENDER ENGINE ---
    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 1. GRID (–û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä—è–º–æ –∑–¥–µ—Å—å, –Ω–∞ —Å–∞–º–æ–º –¥–Ω–µ)
        const g = 50 * state.camera.zoom;
        const offX = state.camera.x % g;
        const offY = state.camera.y % g;
        
        ctx.beginPath();
        ctx.strokeStyle = state.theme === 'light' ? 'rgba(0,0,0,0.06)' : 'rgba(255,255,255,0.06)';
        ctx.lineWidth = 1;
        for (let x = offX; x < canvas.width; x += g) { ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); }
        for (let y = offY; y < canvas.height; y += g) { ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); }
        ctx.stroke();

        ctx.save();
        ctx.translate(state.camera.x, state.camera.y);
        ctx.scale(state.camera.zoom, state.camera.zoom);

        // 2. Objects
        state.objects.forEach(obj => {
            if (obj.type === 'youtube' && obj.dom) {
                // –û–±–Ω–æ–≤–ª—è–µ–º CSS Transform
                obj.dom.style.transform = `translate(${obj.x * state.camera.zoom + state.camera.x}px, ${obj.y * state.camera.zoom + state.camera.y}px) scale(${state.camera.zoom})`;
                obj.dom.style.width = `${obj.w}px`;
                obj.dom.style.height = `${obj.h}px`;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                if (obj.id === state.interactiveId) {
                    obj.dom.classList.add('interactive');
                } else {
                    obj.dom.classList.remove('interactive');
                }
            } 
            else if (obj.el) {
                ctx.drawImage(obj.el, obj.x, obj.y, obj.w, obj.h);
            }

            // –†–∞–º–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è
            if (state.selectedObj === obj && state.mode === 'select') {
                ctx.strokeStyle = '#4285F4';
                ctx.lineWidth = 2 / state.camera.zoom;
                ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
                // –£–≥–ª–æ–≤–æ–π —Ö–µ–Ω–¥–ª
                ctx.fillStyle = '#4285F4';
                const s = 10 / state.camera.zoom; // –†–∞–∑–º–µ—Ä –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∞
                ctx.fillRect(obj.x + obj.w - s, obj.y + obj.h - s, s*2, s*2);
            }
        });

        // 3. Lines
        state.lines.forEach(l => {
            ctx.beginPath();
            ctx.strokeStyle = l.color;
            ctx.lineWidth = 3 / state.camera.zoom;
            ctx.lineCap = 'round';
            l.points.forEach((p, i) => i ? ctx.lineTo(p.x, p.y) : ctx.moveTo(p.x, p.y));
            ctx.stroke();
        });

        ctx.restore();
    }

    // --- UTILS ---
    function getMouse(e) { return { x: e.clientX, y: e.clientY }; }
    function toWorld(m) { return { x: (m.x - state.camera.x) / state.camera.zoom, y: (m.y - state.camera.y) / state.camera.zoom }; }
    function findHit(w) { return [...state.objects].reverse().find(o => w.x > o.x && w.x < o.x + o.w && w.y > o.y && w.y < o.y + o.h); }
    function showHint(text) {
        const h = document.getElementById('hint'); h.innerText = text; h.style.opacity = 1;
        setTimeout(() => h.style.opacity = 0, 3000);
    }

    // --- FIREBASE & APP ---
    window.addYouTube = () => {
        const url = prompt("YouTube Link:");
        const id = url?.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/|.*embed\/|.*shorts\/))([^?&]+)/);
        if (id) {
            const pos = toWorld({x: window.innerWidth/2, y: window.innerHeight/2});
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –æ–±—ä–µ–∫—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å DOM
            const newObj = { 
                id: Date.now().toString(),
                type: 'youtube', 
                x: pos.x, y: pos.y, w: 480, h: 270, 
                ytId: id[1], ratio: 1.77 
            };
            state.objects.push(newObj);
            save();
            showHint("–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç '–ö—É—Ä—Å–æ—Ä' (‚ÜñÔ∏è), —á—Ç–æ–±—ã –º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä");
        }
    };

    async function openBoard(id) {
        if (unsubscribeBoard) unsubscribeBoard();
        
        // CLEANUP PHASE
        state.objects = []; 
        state.lines = []; 
        domLayer.innerHTML = ''; // –£–¥–∞–ª—è–µ–º –≤—Å–µ iframe
        currentBoardId = id;

        unsubscribeBoard = onSnapshot(doc(db, "boards", id), d => {
            if (d.exists() && !state.isMovingObj && !state.isResizing) {
                state.lines = d.data().lines || [];
                syncDOMObjects(d.data().objects || []);
            }
        }, err => console.error("Error:", err));
        
        loadBoardsList();
        document.getElementById('sidebar').classList.remove('open');
    }

    async function save() {
        if (!currentBoardId) return;
        // –û—á–∏—â–∞–µ–º DOM —Å—Å—ã–ª–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ –ë–î
        const cleanObjects = state.objects.map(({dom, el, ...o}) => o);
        await updateDoc(doc(db, "boards", currentBoardId), { objects: cleanObjects, lines: state.lines });
    }

    // Auth & Init
    async function loadBoardsList() {
        const q = query(collection(db, "boards"), where("ownerId", "==", currentUser.uid));
        const snap = await getDocs(q);
        const list = document.getElementById('boards-list'); list.innerHTML = '';
        snap.forEach(d => {
            const div = document.createElement('div');
            div.className = `board-item ${currentBoardId===d.id?'active':''}`;
            div.innerHTML = `<span>${d.data().name}</span>`;
            div.onclick = () => openBoard(d.id);
            list.appendChild(div);
        });
    }

    onAuthStateChanged(auth, user => {
        if (user) {
            currentUser = user; 
            document.getElementById('login-screen').style.display='none'; 
            document.getElementById('ui-layer').style.display='flex';
            loadBoardsList().then(() => { if (!currentBoardId) createNewBoard(true); });
        }
    });

    window.login = () => signInWithPopup(auth, new GoogleAuthProvider());
    window.logout = () => signOut(auth).then(() => location.reload());
    window.setMode = m => { 
        state.mode = m; 
        document.querySelectorAll('.panel button').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('mode-'+m);
        if(btn) btn.classList.add('active');
        state.selectedObj = null; // —Å–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞
        render();
    };
    window.createNewBoard = async (auto = false) => {
        let name = "New Board";
        if (!auto) { name = prompt("Name:"); if (!name) return; }
        else { // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é, –µ—Å–ª–∏ –∞–≤—Ç–æ-–≤—Ö–æ–¥
           const q = query(collection(db, "boards"), where("ownerId", "==", currentUser.uid));
           const snap = await getDocs(q);
           if(!snap.empty) { openBoard(snap.docs[0].id); return; }
        }
        const ref = await addDoc(collection(db, "boards"), { name, ownerId: currentUser.uid, objects: [], lines: [] });
        openBoard(ref.id);
    };
    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
    window.resetCamera = () => { state.camera = { x: window.innerWidth/2, y: window.innerHeight/2, zoom: 1 }; render(); };
    window.deleteSelected = () => { 
        if(state.selectedObj){ 
            if(state.selectedObj.dom) state.selectedObj.dom.remove(); 
            state.objects = state.objects.filter(o => o !== state.selectedObj); 
            state.selectedObj = null; 
            save(); render(); 
        } 
    };
    window.undo = () => {}; // TODO: History stack
    window.redo = () => {}; 
    window.toggleTheme = () => { 
        state.theme = state.theme === 'light' ? 'dark' : 'light'; 
        document.body.setAttribute('data-theme', state.theme); 
        render(); 
    };
</script>
</body>
</html>
