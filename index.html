<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Infinite Board Pro</title>
<style>
  :root {
    --bg-color: #f0f0f0;
    --panel-bg: white;
    --text-color: #333;
    --grid-color: #e2e2e2;
    --border-color: #ddd;
  }

  [data-theme="dark"] {
    --bg-color: #1a1a1a;
    --panel-bg: #333;
    --text-color: #eee;
    --grid-color: #2a2a2a;
    --border-color: #444;
  }

  html, body { margin: 0; height: 100%; overflow: hidden; font-family: sans-serif; background: var(--bg-color); color: var(--text-color); transition: background 0.3s; }
  
  #toolbar {
    position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
    background: var(--panel-bg); padding: 10px 20px; border-radius: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 10;
    display: flex; gap: 12px; align-items: center; border: 1px solid var(--border-color);
  }
  
  canvas { display: block; }
  
  button { 
    background: #eee; color: #333; border: 1px solid #ccc; padding: 8px 12px; 
    border-radius: 20px; cursor: pointer; transition: 0.2s; font-size: 14px;
  }
  
  [data-theme="dark"] button { background: #444; color: #eee; border-color: #555; }
  
  button:hover { opacity: 0.8; }
  button.active { background: #007bff !important; color: white !important; border-color: #0056b3 !important; }
  
  input[type="color"] { border: none; width: 30px; height: 30px; cursor: pointer; background: none; }
  
  .hint { position: fixed; bottom: 10px; right: 10px; color: #999; font-size: 11px; pointer-events: none; }
</style>
</head>
<body data-theme="light">

<div id="toolbar">
  <button onclick="toggleTheme()" id="themeBtn">üåô</button>
  <button onclick="openProject()">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
  <button onclick="saveProject()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <hr style="border: 0; border-left: 1px solid var(--border-color); height: 20px;">
  <input type="file" id="fileInput" style="display:none" accept="image/*,video/*" onchange="addMedia(event)">
  <button onclick="document.getElementById('fileInput').click()">‚ûï –ú–µ–¥–∏–∞</button>
  <button id="btn-draw" onclick="setMode('draw')">‚úèÔ∏è –†–∏—Å–æ–≤–∞—Ç—å</button>
  <button id="btn-move" onclick="setMode('move')" class="active">üñêÔ∏è –î–≤–∏–≥–∞—Ç—å</button>
  <input type="color" id="colorPicker" value="#000000">
  <button onclick="clearBoard()" style="background: #ffeded !important; color: #c00 !important;">üóëÔ∏è</button>
</div>

<div class="hint">–ö–æ–ª–µ—Å–æ: –ó—É–º | –ü–ö–ú: –£–¥–∞–ª–∏—Ç—å | –ü—Ä–æ–±–µ–ª: –î–≤–∏–≥–∞—Ç—å</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const colorPicker = document.getElementById('colorPicker');

let mode = 'move';
let objects = []; 
let lines = [];   
let isDrawing = false;
let isPanning = false;

let camera = { x: window.innerWidth/2, y: window.innerHeight/2, zoom: 1 };
let lastMouse = { x: 0, y: 0 };
let fileHandle = null;

function toggleTheme() {
  const body = document.body;
  const btn = document.getElementById('themeBtn');
  if (body.getAttribute('data-theme') === 'light') {
    body.setAttribute('data-theme', 'dark');
    btn.innerText = '‚òÄÔ∏è';
    if (colorPicker.value === '#000000') colorPicker.value = '#ffffff';
  } else {
    body.setAttribute('data-theme', 'light');
    btn.innerText = 'üåô';
    if (colorPicker.value === '#ffffff') colorPicker.value = '#000000';
  }
  render();
}

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  render();
}
window.onresize = resize;
resize();

function setMode(m) {
  mode = m;
  document.querySelectorAll('#toolbar button').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-' + m).classList.add('active');
}

function getWorldPos(e) {
  return {
    x: (e.clientX - camera.x) / camera.zoom,
    y: (e.clientY - camera.y) / camera.zoom
  };
}

canvas.addEventListener('wheel', e => {
  e.preventDefault();
  const delta = e.deltaY > 0 ? 0.9 : 1.1;
  const mouseBefore = getWorldPos(e);
  camera.zoom *= delta;
  camera.zoom = Math.max(0.1, Math.min(camera.zoom, 5));
  const mouseAfter = getWorldPos(e);
  camera.x += (mouseAfter.x - mouseBefore.x) * camera.zoom;
  camera.y += (mouseAfter.y - mouseBefore.y) * camera.zoom;
  render();
}, { passive: false });

canvas.addEventListener('pointerdown', e => {
  lastMouse = { x: e.clientX, y: e.clientY };
  const worldPos = getWorldPos(e);

  if (e.button === 2) {
    objects = objects.filter(o => !(worldPos.x > o.x && worldPos.x < o.x + o.w && worldPos.y > o.y && worldPos.y < o.y + o.h));
    render();
    return;
  }

  if (mode === 'draw') {
    isDrawing = true;
    lines.push({ points: [worldPos], color: colorPicker.value });
  } else {
    isPanning = true;
  }
});

canvas.addEventListener('pointermove', e => {
  const worldPos = getWorldPos(e);
  if (isDrawing) {
    lines[lines.length - 1].points.push(worldPos);
    render();
  } else if (isPanning) {
    camera.x += e.clientX - lastMouse.x;
    camera.y += e.clientY - lastMouse.y;
    lastMouse = { x: e.clientX, y: e.clientY };
    render();
  }
});

window.addEventListener('pointerup', () => { isDrawing = false; isPanning = false; });
canvas.oncontextmenu = (e) => e.preventDefault();

function addMedia(e) {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  const worldCenter = { x: (window.innerWidth/2 - camera.x) / camera.zoom, y: (window.innerHeight/2 - camera.y) / camera.zoom };
  
  if (file.type.startsWith('video')) {
    const video = document.createElement('video');
    video.src = url; video.muted = true; video.loop = true; video.play();
    objects.push({ type: 'video', el: video, x: worldCenter.x - 200, y: worldCenter.y - 112, w: 400, h: 225 });
    video.onloadeddata = render;
  } else {
    const img = new Image();
    img.src = url;
    img.onload = () => {
      objects.push({ type: 'image', el: img, x: worldCenter.x - (img.width/4), y: worldCenter.y - (img.height/4), w: img.width/2, h: img.height/2 });
      render();
    };
  }
}

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawGrid();
  ctx.save();
  ctx.translate(camera.x, camera.y);
  ctx.scale(camera.zoom, camera.zoom);

  objects.forEach(o => {
    ctx.drawImage(o.el, o.x, o.y, o.w, o.h);
    if (o.type === 'video') requestAnimationFrame(render);
  });

  lines.forEach(line => {
    ctx.beginPath();
    ctx.strokeStyle = line.color;
    ctx.lineWidth = 2 / camera.zoom;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.moveTo(line.points[0].x, line.points[0].y);
    line.points.forEach(p => ctx.lineTo(p.x, p.y));
    ctx.stroke();
  });
  ctx.restore();
}

function drawGrid() {
  const size = 50 * camera.zoom;
  ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--grid-color');
  ctx.lineWidth = 1;
  ctx.beginPath();
  for (let x = camera.x % size; x < canvas.width; x += size) {
    ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height);
  }
  for (let y = camera.y % size; y < canvas.height; y += size) {
    ctx.moveTo(0, y); ctx.lineTo(canvas.width, y);
  }
  ctx.stroke();
}

function clearBoard() {
  if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?")) { objects = []; lines = []; render(); }
}

async function saveProject() {
  const data = JSON.stringify({ camera, lines, theme: document.body.getAttribute('data-theme') }); 
  try {
    if (!fileHandle) {
      fileHandle = await window.showSaveFilePicker({ suggestedName: 'board.json' });
    }
    const writable = await fileHandle.createWritable();
    await writable.write(data);
    await writable.close();
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
  } catch (e) {
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'board.json'; a.click();
  }
}

async function openProject() {
  try {
    const [handle] = await window.showOpenFilePicker();
    fileHandle = handle;
    const file = await fileHandle.getFile();
    const content = JSON.parse(await file.text());
    camera = content.camera;
    lines = content.lines;
    if (content.theme) {
        document.body.setAttribute('data-theme', content.theme);
        document.getElementById('themeBtn').innerText = content.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }
    render();
  } catch (e) { console.log(e); }
}
</script>
</body>
</html>
