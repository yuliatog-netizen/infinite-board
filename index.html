<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Infinite Board Pro</title>
<style>
  html, body { margin: 0; height: 100%; overflow: hidden; font-family: sans-serif; background: #e5e5e5; }
  #toolbar {
    position: fixed; top: 10px; left: 10px; background: white;
    padding: 10px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    z-index: 10; display: flex; gap: 8px; align-items: center;
  }
  canvas { display: block; cursor: crosshair; }
  button { padding: 6px 12px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff; }
  button.active { background: #007bff; color: white; border-color: #0056b3; }
</style>
</head>
<body>

<div id="toolbar">
  <button onclick="openProject()">ğŸ“‚</button>
  <button onclick="saveProject()">ğŸ’¾</button>
  <input type="file" id="fileInput" style="display:none" accept="image/*" onchange="addMedia(event)">
  <button onclick="document.getElementById('fileInput').click()">ğŸ–¼ï¸ +</button>
  <hr>
  <button id="btn-draw" onclick="setMode('draw')">âœï¸ Ğ Ğ¸ÑĞ¾Ğ²Ğ°Ñ‚ÑŒ</button>
  <button id="btn-move" onclick="setMode('move')" class="active">ğŸ–ï¸ Ğ”Ğ²Ğ¸Ğ³Ğ°Ñ‚ÑŒ</button>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let mode = 'move';
let objects = []; // Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ¼ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸
let lines = [];   // Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ¼ Ğ»Ğ¸Ğ½Ğ¸Ğ¸
let isDrawing = false;
let isPanning = false;

// Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ĞºĞ°Ğ¼ĞµÑ€Ñ‹ (ÑĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ)
let camera = { x: 0, y: 0 };
let lastMouse = { x: 0, y: 0 };

function setMode(m) {
  mode = m;
  document.querySelectorAll('#toolbar button').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-' + m).classList.add('active');
}

canvas.addEventListener('pointerdown', e => {
  lastMouse = { x: e.clientX, y: e.clientY };
  if (mode === 'draw') {
    isDrawing = true;
    // ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ»Ğ¸Ğ½Ğ¸Ñ. ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ ÑĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ¼ĞµÑ€Ñ‹!
    lines.push({
      points: [{ x: e.clientX - camera.x, y: e.clientY - camera.y }],
      color: '#000'
    });
  } else {
    isPanning = true;
  }
});

canvas.addEventListener('pointermove', e => {
  if (isDrawing && mode === 'draw') {
    const currentLine = lines[lines.length - 1];
    currentLine.points.push({ x: e.clientX - camera.x, y: e.clientY - camera.y });
    render();
  } else if (isPanning && mode === 'move') {
    camera.x += e.clientX - lastMouse.x;
    camera.y += e.clientY - lastMouse.y;
    lastMouse = { x: e.clientX, y: e.clientY };
    render();
  }
});

window.addEventListener('pointerup', () => {
  isDrawing = false;
  isPanning = false;
});

function addMedia(e) {
  const file = e.target.files[0];
  if (!file) return;
  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = () => {
    objects.push({ 
      img, 
      x: (canvas.width/2) - camera.x - 100, 
      y: (canvas.height/2) - camera.y - 100,
      w: 200, h: 200 
    });
    render();
  };
}

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  ctx.save();
  ctx.translate(camera.x, camera.y); // "Ğ”Ğ²Ğ¸Ğ³Ğ°ĞµĞ¼" Ğ²ĞµÑÑŒ Ğ¼Ğ¸Ñ€

  // 1. Ğ Ğ¸ÑÑƒĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸
  objects.forEach(obj => {
    ctx.drawImage(obj.img, obj.x, obj.y, obj.w, obj.h);
  });

  // 2. Ğ Ğ¸ÑÑƒĞµĞ¼ Ğ»Ğ¸Ğ½Ğ¸Ğ¸
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  ctx.lineWidth = 3;
  lines.forEach(line => {
    ctx.beginPath();
    ctx.moveTo(line.points[0].x, line.points[0].y);
    line.points.forEach(p => ctx.lineTo(p.x, p.y));
    ctx.stroke();
  });

  ctx.restore();
}

// Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¾Ñ‚Ñ€Ğ¸ÑĞ¾Ğ²ĞºĞ¸
render();

// Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° (ÑƒĞ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ğ¾)
async function saveProject() {
    const data = JSON.stringify({
        camera,
        lines,
        objects: objects.map(o => ({x: o.x, y: o.y, w: o.w, h: o.h, src: o.img.src}))
    });
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'board.json';
    a.click();
}

// ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° (Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ input Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸)
function openProject() {
    const input = document.createElement('input');
    input.type = 'file';
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = JSON.parse(event.target.result);
            lines = data.lines;
            camera = data.camera;
            objects = data.objects.map(o => {
                const img = new Image();
                img.src = o.src;
                img.onload = render;
                return {...o, img};
            });
            render();
        };
        reader.readAsText(file);
    };
    input.click();
}
</script>
</body>
</html>
